--- a/roundcubemail-plugins-kolab.orig	2018-11-30 21:09:09.675970989 +0100
+++ b/roundcubemail-plugins-kolab.spec	2018-11-30 21:10:04.095762745 +0100
@@ -30,7 +30,7 @@
 
 Name:           roundcubemail-plugins-kolab
 Version:        3.3.6
-Release:        1%{?dist}
+Release:        103.tbits%(date +%%Y%%m%%d)%{?dist}
 Summary:        Kolab Groupware plugins for Roundcube Webmail
 
 Group:          Applications/Internet
@@ -48,8 +48,17 @@
 
 Patch0001:      0001-Fix-missing-first-occurrence-of-an-event-when-moved-.patch
 
+Source200:      ude_login.inc.php
+Source201:      ude_login.php
+
 Patch1001:      roundcubemail-plugins-kolab-3.3-kolab-files-manticore-api.patch
 
+# from initSetupKolabPatches.sh
+Patch10:         roundcubeStorageMariadbBug4883.patch
+Patch11:         roundcube_calendar_etc_timezone_T2666.patch
+
+Patch12:         canonification_via_uid_roundcube.patch
+
 BuildRoot:      %(mktemp -ud %{_tmppath}/%{name}-%{version}-%{release}-XXXXXX)
 BuildArch:      noarch
 
@@ -74,7 +83,7 @@
 Requires:       php-kolab >= 0.5
 Requires:       php-pear(HTTP_Request2)
 %if 0%{?plesk} < 1
-Requires:       php-pear(Net_LDAP3)
+Requires:       php-kolab-net-ldap3
 %endif
 Requires:       php-pear(Mail_Mime) >= 1.8.5
 Requires:       roundcubemail >= %{roundcube_version}
@@ -91,6 +100,7 @@
 Requires:       roundcubemail(plugin-odfviewer) = %{?epoch:%{epoch}:}%{version}-%{release}
 Requires:       roundcubemail(plugin-pdfviewer) = %{?epoch:%{epoch}:}%{version}-%{release}
 Requires:       roundcubemail(plugin-tasklist) = %{?epoch:%{epoch}:}%{version}-%{release}
+Requires:       roundcubemail(plugin-ude_login) = %{?epoch:%{epoch}:}%{version}-%{release}
 Obsoletes:      roundcubemail-kolab < %{version}-%{release}
 Provides:       roundcubemail-kolab = %{version}-%{release}
 
@@ -141,6 +151,17 @@
 %description -n roundcubemail-plugin-kolab_2fa
 Plugin kolab_2fa
 
+%package -n roundcubemail-plugin-ude_login
+Summary:        Plugin ude_login
+Group:          Applications/Internet
+Requires:       roundcubemail(core) >= %{roundcube_version}
+Requires:       roundcubemail(plugin-ude_login-assets) = %{?epoch:%{epoch}:}%{version}-%{release}
+Requires:       roundcubemail(plugin-ude_login-skin) = %{?epoch:%{epoch}:}%{version}-%{release}
+Provides:       roundcubemail(plugin-ude_login) = %{?epoch:%{epoch}:}%{version}-%{release}
+
+%description -n roundcubemail-plugin-ude_login
+Plugin ude_login
+
 %package -n roundcubemail-plugin-kolab_activesync
 Summary:        Plugin kolab_activesync
 Group:          Applications/Internet
@@ -393,6 +414,14 @@
 %description -n roundcubemail-plugin-kolab_2fa-assets
 Plugin kolab_2fa Assets
 
+%package -n roundcubemail-plugin-ude_login-assets
+Summary:        Plugin ude_login Assets
+Group:          Applications/Internet
+Provides:       roundcubemail(plugin-ude_login-assets) = %{?epoch:%{epoch}:}%{version}-%{release}
+
+%description -n roundcubemail-plugin-ude_login-assets
+Plugin ude_login Assets
+
 %package -n roundcubemail-plugin-kolab_activesync-assets
 Summary:        Plugin kolab_activesync Assets
 Group:          Applications/Internet
@@ -597,6 +626,18 @@
 %description -n roundcubemail-plugin-kolab_2fa-skin-larry
 Plugin kolab_2fa / Skin larry
 
+%package -n roundcubemail-plugin-ude_login-skin-larry
+Summary:        Plugin ude_login / Skin larry
+Group:          Applications/Internet
+Requires:       roundcubemail(plugin-ude_login) = %{?epoch:%{epoch}:}%{version}-%{release}
+Requires:       roundcubemail(skin-larry) >= %{roundcube_version}
+Requires:       roundcubemail(plugin-ude_login-skin-larry-assets) = %{?epoch:%{epoch}:}%{version}-%{release}
+Provides:       roundcubemail(plugin-ude_login-skin) = %{?epoch:%{epoch}:}%{version}-%{release}
+Provides:       roundcubemail(plugin-ude_login-skin-larry) = %{?epoch:%{epoch}:}%{version}-%{release}
+
+%description -n roundcubemail-plugin-ude_login-skin-larry
+Plugin ude_login / Skin larry
+
 %package -n roundcubemail-plugin-kolab_activesync-skin-larry
 Summary:        Plugin kolab_activesync / Skin larry
 Group:          Applications/Internet
@@ -741,6 +782,14 @@
 %description -n roundcubemail-plugin-kolab_2fa-skin-larry-assets
 Plugin kolab_2fa / Skin larry (Assets Package)
 
+%package -n roundcubemail-plugin-ude_login-skin-larry-assets
+Summary:        Plugin ude_login / Skin larry (Assets)
+Group:          Applications/Internet
+Provides:       roundcubemail(plugin-ude_login-skin-larry-assets) = %{?epoch:%{epoch}:}%{version}-%{release}
+
+%description -n roundcubemail-plugin-ude_login-skin-larry-assets
+Plugin ude_login / Skin larry (Assets Package)
+
 %package -n roundcubemail-plugin-kolab_activesync-skin-larry-assets
 Summary:        Plugin kolab_activesync / Skin larry (Assets)
 Group:          Applications/Internet
@@ -862,6 +911,13 @@
 
 %patch0001 -p1
 %patch1001 -p1
+%patch10 -p1
+%patch11 -p1
+%patch12 -p1
+ 
+mkdir -p plugins/ude_login
+cp -af %{SOURCE200} plugins/ude_login/config.inc.php.dist
+cp -af %{SOURCE201} plugins/ude_login/ude_login.php
 
 find -type d -name "helpdocs" -exec rm -rvf {} \; 2>/dev/null || :
 
@@ -1297,6 +1353,11 @@
     %{__rm} -f "%{_localstatedir}/lib/rpm-state/roundcubemail/httpd.restarted"
 fi
 
+%pre -n roundcubemail-plugin-ude_login
+if [ -f "%{_localstatedir}/lib/rpm-state/roundcubemail/httpd.restarted" ]; then
+    %{__rm} -f "%{_localstatedir}/lib/rpm-state/roundcubemail/httpd.restarted"
+fi
+
 %pre -n roundcubemail-plugin-kolab_activesync
 if [ -f "%{_localstatedir}/lib/rpm-state/roundcubemail/httpd.restarted" ]; then
     %{__rm} -f "%{_localstatedir}/lib/rpm-state/roundcubemail/httpd.restarted"
@@ -1446,6 +1507,21 @@
     touch %{_localstatedir}/lib/rpm-state/roundcubemail/httpd.restarted
 fi
 
+%posttrans -n roundcubemail-plugin-ude_login
+if [ ! -f "%{_localstatedir}/lib/rpm-state/roundcubemail/httpd.restarted" ]; then
+    if [ -f "%{php_inidir}/apc.ini" -o -f "%{php_inidir}/apcu.ini" ]; then
+        if [ ! -z "$(grep ^apc.enabled=1 %{php_inidir}/apc{,u}.ini)" ]; then
+%if 0%{?with_systemd}
+            /bin/systemctl condrestart %{httpd_name}.service
+%else
+            /sbin/service %{httpd_name} condrestart
+%endif
+        fi
+    fi
+    %{__mkdir_p} %{_localstatedir}/lib/rpm-state/roundcubemail/
+    touch %{_localstatedir}/lib/rpm-state/roundcubemail/httpd.restarted
+fi
+
 %posttrans -n roundcubemail-plugin-kolab_activesync
 if [ ! -f "%{_localstatedir}/lib/rpm-state/roundcubemail/httpd.restarted" ]; then
     if [ -f "%{php_inidir}/apc.ini" -o -f "%{php_inidir}/apcu.ini" ]; then
@@ -1795,6 +1871,10 @@
 %defattr(-,root,root,-)
 %attr(0640,root,%{httpd_group}) %config(noreplace) %{confdir}/kolab_2fa.inc.php
 
+%files -n roundcubemail-plugin-ude_login -f plugin-ude_login.files
+%defattr(-,root,root,-)
+%attr(0640,root,%{httpd_group}) %config(noreplace) %{confdir}/ude_login.inc.php
+
 %files -n roundcubemail-plugin-kolab_activesync -f plugin-kolab_activesync.files
 %defattr(-,root,root,-)
 %attr(0640,root,%{httpd_group}) %config(noreplace) %{confdir}/kolab_activesync.inc.php
@@ -1876,6 +1956,9 @@
 %files -n roundcubemail-plugin-kolab_2fa-assets -f plugin-kolab_2fa-assets.files
 %defattr(-,root,root,-)
 
+%files -n roundcubemail-plugin-ude_login-assets -f plugin-ude_login-assets.files
+%defattr(-,root,root,-)
+
 %files -n roundcubemail-plugin-kolab_activesync-assets -f plugin-kolab_activesync-assets.files
 %defattr(-,root,root,-)
 
@@ -1945,6 +2028,9 @@
 %files -n roundcubemail-plugin-kolab_2fa-skin-larry -f plugin-kolab_2fa-skin-larry.files
 %defattr(-,root,root,-)
 
+%files -n roundcubemail-plugin-ude_login-skin-larry -f plugin-ude_login-skin-larry.files
+%defattr(-,root,root,-)
+
 %files -n roundcubemail-plugin-kolab_activesync-skin-larry -f plugin-kolab_activesync-skin-larry.files
 %defattr(-,root,root,-)
 
@@ -1984,6 +2070,9 @@
 %files -n roundcubemail-plugin-kolab_2fa-skin-larry-assets -f plugin-kolab_2fa-skin-larry-assets.files
 %defattr(-,root,root,-)
 
+%files -n roundcubemail-plugin-ude_login-skin-larry-assets -f plugin-ude_login-skin-larry-assets.files
+%defattr(-,root,root,-)
+
 %files -n roundcubemail-plugin-kolab_activesync-skin-larry-assets -f plugin-kolab_activesync-skin-larry-assets.files
 %defattr(-,root,root,-)
 
